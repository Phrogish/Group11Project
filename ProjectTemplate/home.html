<!DOCTYPE html>
<html>
<head>
    <title>Employee Home</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>

    <h1>Welcome Employee!</h1>

    <h2 id="pointsDisplay"></h2>
    <div id="userInfo"></div>

    <button onclick="logout()">Logout</button>

    <!-- button for registering new employees for the admins-->
    <button id="adminRegisterBtn" style="display:none;" onclick="goToRegister()">
        Register New Employee
    </button>

    <!-- DAILY PULSE POPUP (HTML MUST BE OUTSIDE <script>) -->
    <div id="pulseOverlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,.45); z-index:9999;">
        <div style="background:white; width:340px; margin:12% auto; padding:18px; border-radius:12px; text-align:center; font-family:Arial;">
            <h3 style="margin-top:0;">How are you feeling today?</h3>
            <p style="margin-top:4px; color:#555;">Select one emoji to submit</p>

            <div style="display:flex; justify-content:space-between; gap:10px; margin:14px 0;">
                <button class="pulseEmoji" data-mood="😄" style="font-size:26px; padding:10px; border-radius:10px;">😄</button>
                <button class="pulseEmoji" data-mood="🙂" style="font-size:26px; padding:10px; border-radius:10px;">🙂</button>
                <button class="pulseEmoji" data-mood="😐" style="font-size:26px; padding:10px; border-radius:10px;">😐</button>
                <button class="pulseEmoji" data-mood="😕" style="font-size:26px; padding:10px; border-radius:10px;">😕</button>
                <button class="pulseEmoji" data-mood="😠" style="font-size:26px; padding:10px; border-radius:10px;">😠</button>
            </div>

            <div id="pulseMsg" style="min-height:20px; color:#333;"></div>
        </div>
    </div>

    <script>
        // Runs once when home.html loads
        $(document).ready(function () {
            $.ajax({
                type: "POST",
                url: "ProjectServices.asmx/Me",
                data: "{}",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    let result = msg.d;

                    if (!result.loggedIn) {
                        window.location.href = "index.html";
                    } else {
                        $("#userInfo").text("User ID: " + result.userId + " | Role: " + result.role);
                        loadPoints();
                        checkDailyPulse(); // ✅ show popup if user hasn't answered today
                    }
                    // Show admin button if user is an admin
                    if ((result.role || "").toLowerCase() === "admin") {
                        $("#adminRegisterBtn").show();
                    }
                },
                error: function (e) {
                    console.log(e);
                    window.location.href = "index.html";
                }
            });
        });

        function loadPoints() {
            $.ajax({
                type: "POST",
                url: "ProjectServices.asmx/GetPoints",
                data: "{}",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    let points = msg.d;
                    $("#pointsDisplay").text("⭐ Your Points: " + points);
                },
                error: function (e) {
                    console.log(e);
                    $("#pointsDisplay").text("Could not load points.");
                }
            });
        }

        function logout() {
            $.ajax({
                type: "POST",
                url: "ProjectServices.asmx/Logout",
                data: "{}",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function () {
                    window.location.href = "index.html";
                },
                error: function (e) {
                    console.log(e);
                    window.location.href = "index.html";
                }
            });
        }

        // ===== DAILY PULSE JS =====
        function showPulse() {
            $("#pulseMsg").text("");
            $("#pulseOverlay").show();
        }

        function hidePulse() {
            $("#pulseOverlay").hide();
        }

        function checkDailyPulse() {
            $.ajax({
                type: "POST",
                url: "ProjectServices.asmx/GetDailyPulseStatus",
                data: "{}",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    let resp = msg.d;
                    if (resp.loggedIn && resp.shouldShow) {
                        showPulse();
                    }
                },
                error: function (e) {
                    console.log(e);
                }
            });
        }
        //using function to use the button for admins to register html page
        function goToRegister() {
            window.location.href = "register.html";
        }

        // When an emoji is clicked, submit pulse + award points
        $(document).on("click", ".pulseEmoji", function () {
            var mood = $(this).data("mood");
            $("#pulseMsg").text("Submitting...");

            $.ajax({
                type: "POST",
                url: "ProjectServices.asmx/SubmitDailyPulse",
                data: JSON.stringify({ mood: mood }),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    let resp = msg.d;
                    $("#pulseMsg").text(resp.message);

                    if (resp.success) {
                        loadPoints(); // refresh points display
                        setTimeout(hidePulse, 900);
                    }
                },
                error: function (e) {
                    console.log(e);
                    $("#pulseMsg").text("Error submitting. Please try again.");
                }
            });
            
        });
    </script>

</body>
</html>
